apiVersion: apiextensions.crossplane.io/v2
kind: CompositeResourceDefinition
metadata:
  name: helmapplications.dip.io
spec:
  group: dip.io
  names:
    kind: HelmApplication
    plural: helmapplications
  # Namespace scope - compositions will be namespace-scoped
  scope: Namespaced
  
  versions:
  - name: v1alpha1
    served: true
    referenceable: true
    schema:
      openAPIV3Schema:
        type: object
        properties:
          spec:
            type: object
            properties:
              # Source specification (matches ArgoCD Application spec.source)
              source:
                type: object
                description: "Source specification for the Helm chart"
                properties:
                  # Chart name (e.g., "my-chart")
                  chart:
                    type: string
                    description: "Name of the Helm chart to deploy"
                  
                  # Chart repository URL
                  repoURL:
                    type: string
                    description: "URL of the Helm chart repository"
                  
                  # Chart version/revision
                  targetRevision:
                    type: string
                    description: "Target revision (version) of the Helm chart"
                  
                  # Optional path within the repository
                  path:
                    type: string
                    description: "Optional path to the chart within the repository"
                  
                  # Helm configuration
                  helm:
                    type: object
                    description: "Helm configuration"
                    properties:
                      # Helm release name
                      releaseName:
                        type: string
                        description: "Helm release name (defaults to the HelmApplication resource name)"
                      # Helm values as an object
                      valuesObject:
                        type: object
                        description: "Helm chart values as key-value pairs"
                        x-kubernetes-preserve-unknown-fields: true
                  
                  # Optional array of prefixes to filter environmentConfigs
                  withConfigKeys:
                    type: array
                    description: "Optional array of string prefixes to filter which environmentConfigs to include. If empty or not provided, all environmentConfigs are included."
                    items:
                      type: string
                
                required:
                - repoURL
                - targetRevision
              
              # ArgoCD project name
              project:
                type: string
                description: "ArgoCD project name (defaults to 'default')"
                default: "default"
              
              # ArgoCD sync policy
              syncPolicy:
                type: object
                description: "ArgoCD sync policy configuration"
                properties:
                  automated:
                    type: object
                    description: "Automated sync configuration"
                    properties:
                      prune:
                        type: boolean
                        description: "Enable automatic pruning of resources"
                        default: true
                      selfHeal:
                        type: boolean
                        description: "Enable automatic self-healing"
                        default: true
                      allowEmpty:
                        type: boolean
                        description: "Allow apps to have zero live resources"
                        default: false
                      enabled:
                        type: boolean
                        description: "Enable automated sync"
                        default: true
                  managedNamespaceMetadata:
                    type: object
                    description: "Controls metadata in the managed namespace (if CreateNamespace=true)"
                    properties:
                      labels:
                        type: object
                        description: "Labels to apply to the managed namespace"
                        x-kubernetes-preserve-unknown-fields: true
                      annotations:
                        type: object
                        description: "Annotations to apply to the managed namespace"
                        x-kubernetes-preserve-unknown-fields: true
                  retry:
                    type: object
                    description: "Controls failed sync retry behavior"
                    properties:
                      limit:
                        type: integer
                        description: "Maximum number of attempts for retrying a failed sync (0 = no retries)"
                        format: int64
                        default: 5
                      backoff:
                        type: object
                        description: "Backoff strategy for retries"
                        properties:
                          duration:
                            type: string
                            description: "Amount to back off (e.g., '5s', '2m', '1h')"
                            default: "5s"
                          factor:
                            type: integer
                            description: "Factor to multiply the base duration after each failed retry"
                            format: int64
                            default: 2
                          maxDuration:
                            type: string
                            description: "Maximum amount of time allowed for the backoff strategy (e.g., '3m')"
                            default: "3m"
                  syncOptions:
                    type: array
                    description: "Sync options"
                    items:
                      type: string
                    default:
                    - CreateNamespace=true
            
            required:
            - source
          
          status:
            type: object
            properties:
              conditions:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                    status:
                      type: string
                    lastTransitionTime:
                      type: string
                    reason:
                      type: string
                    message:
                      type: string
