# S3IRSA Observed Resources

This document describes the AWS and Kubernetes resources created by the S3IRSA composition.

## Resources Created

### When Creating a New S3 Bucket

#### 1. S3 Bucket (`s3.aws.m.upbound.io/v1beta1/Bucket`)
- **Name Pattern**: `{composite-name}-bucket`
- **External Name**: Configured bucket name or auto-generated
- **Purpose**: Stores application data
- **Features**:
  - Globally unique bucket name
  - Region-specific deployment
  - Tagging support

#### 2. S3 Bucket Versioning (`s3.aws.m.upbound.io/v1beta1/BucketVersioningV2`)
- **Name Pattern**: `{composite-name}-versioning`
- **Purpose**: Enable version control for bucket objects
- **Created When**: `spec.bucketConfig.versioning: true`

#### 3. S3 Bucket Encryption (`s3.aws.m.upbound.io/v1beta1/BucketServerSideEncryptionConfigurationV2`)
- **Name Pattern**: `{composite-name}-encryption`
- **Purpose**: Configure server-side encryption
- **Encryption Types**:
  - AES256 (AWS managed key - default)
  - aws:kms (customer managed key - when `existingKmsKeyId` specified)
- **Features**: Bucket key enabled for cost optimization

#### 4. S3 Bucket Public Access Block (`s3.aws.m.upbound.io/v1beta1/BucketPublicAccessBlock`)
- **Name Pattern**: `{composite-name}-public-access-block`
- **Purpose**: Block all public access to the bucket
- **Configuration**: All blocking options enabled for maximum security

### Always Created

#### 5. IAM Role (`iam.aws.m.upbound.io/v1beta1/Role`)
- **Name Pattern**: `{composite-name}-irsa-role`
- **Purpose**: Provide AWS credentials to Kubernetes ServiceAccount
- **Trust Policy**: Configured for IRSA with:
  - EKS OIDC provider
  - Specific ServiceAccount in specific namespace
  - Audience: sts.amazonaws.com

#### 6. IAM Policy (`iam.aws.m.upbound.io/v1beta1/Policy`)
- **Name Pattern**: `{composite-name}-s3-policy`
- **Purpose**: Define S3 and KMS permissions
- **Permissions**:
  - S3 object operations (Get, Put, Delete based on configuration)
  - S3 bucket operations (List, GetBucketLocation)
  - KMS operations (Encrypt, Decrypt, GenerateDataKey when encryption enabled)
- **Resource Scope**: Limited to specific bucket ARN

#### 7. IAM Role Policy Attachment (`iam.aws.m.upbound.io/v1beta1/RolePolicyAttachment`)
- **Name Pattern**: `{composite-name}-role-policy-attachment`
- **Purpose**: Attach the policy to the role
- **Links**: IAM Role + IAM Policy

### External Resources (Not Managed by Composition)

#### Kubernetes ServiceAccount
- **Must be created separately** by the user or another system
- **Required Annotation**: `eks.amazonaws.com/role-arn` with the IAM role ARN from the S3IRSA status
- **Namespace**: Must match the S3IRSA resource namespace
- **Name**: Must match `spec.serviceAccountName` in the S3IRSA spec

## Resource Dependencies

```
S3IRSA Composite Resource
│
├─> S3 Bucket (if creating new)
│   ├─> Bucket Versioning (if enabled)
│   ├─> Bucket Encryption (if enabled)
│   └─> Bucket Public Access Block
│
├─> IAM Role (with IRSA trust policy)
│
├─> IAM Policy (S3 + KMS permissions)
│
└─> IAM Role Policy Attachment
    ├─> Requires: IAM Role
    └─> Requires: IAM Policy

External (user-managed):
└─> Kubernetes ServiceAccount
    └─> Annotation requires: IAM Role ARN (from S3IRSA status)
```

## Composition Annotations

All resources include the following annotation for tracking:
- `gotemplating.fn.crossplane.io/composition-resource-name`: Internal resource name

## External Name Handling

- **S3 Bucket**: Uses `crossplane.io/external-name` annotation to set bucket name
- **IAM Resources**: Auto-generated by AWS based on Crossplane resource name
- **ServiceAccount**: Name set via `spec.serviceAccountName` parameter

## Status Propagation

The composition automatically populates these status fields on the S3IRSA resource:
- `bucketName`: From S3 Bucket (or input parameter for existing bucket)
- `bucketArn`: From S3 Bucket
- `roleArn`: From IAM Role

## Provider Configuration

All AWS resources reference `providerConfigRef.name: default`

Ensure these ProviderConfigs exist:
- `provider-aws-s3` ProviderConfig
- `provider-aws-iam` ProviderConfig
